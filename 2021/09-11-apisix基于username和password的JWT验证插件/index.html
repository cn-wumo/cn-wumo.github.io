<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>apisix基于username和password的JWT验证插件 - 超级午默共同体</title>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="插件说明基于jwt-auth插件，新增了password字段和相应的逻辑判断。 jwt-diy的属性表如下：    名称 类型 必选项 默认值 有效值 描述    key string 必须   不同的 consumer 对象应有不同的值，它应当是唯一的。不同 consumer 使用了相同的 key ，将会出现请求匹配异常。   password string 必须   Key对应的口令，唯有ke">
<meta property="og:type" content="article">
<meta property="og:title" content="apisix基于username和password的JWT验证插件">
<meta property="og:url" content="http://cn-wumo.top/2021/09-11-apisix%E5%9F%BA%E4%BA%8Eusername%E5%92%8Cpassword%E7%9A%84JWT%E9%AA%8C%E8%AF%81%E6%8F%92%E4%BB%B6/index.html">
<meta property="og:site_name" content="超级午默共同体">
<meta property="og:description" content="插件说明基于jwt-auth插件，新增了password字段和相应的逻辑判断。 jwt-diy的属性表如下：    名称 类型 必选项 默认值 有效值 描述    key string 必须   不同的 consumer 对象应有不同的值，它应当是唯一的。不同 consumer 使用了相同的 key ，将会出现请求匹配异常。   password string 必须   Key对应的口令，唯有ke">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-11T10:35:16.000Z">
<meta property="article:modified_time" content="2021-09-15T08:03:22.852Z">
<meta property="article:author" content="cn_wumo">
<meta property="article:tag" content="Apisix">
<meta property="article:tag" content="网关">
<meta name="twitter:card" content="summary">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1631693947704">
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1631693947704">
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/cover/5c3aec85a4343.jpg)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="cn_wumo" class="mdui-btn mdui-btn-icon"><img src="https://cdn.jsdelivr.net/gh/cn-wumo/cn-wumo.github.io@latest/images/45330971.jpg" alt="cn_wumo"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="cn_wumo">
            <img src="https://cdn.jsdelivr.net/gh/cn-wumo/cn-wumo.github.io@latest/images/45330971.jpg" alt="cn_wumo" alt="cn_wumo">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>4</div>
        <div><span>标签</span>4</div>
        <div><span>分类</span>4</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archives.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/?_wv=1027&k=0x8Tz36T" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/cn-wumo/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/中间件/">中间件</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/后端/">后端</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/数据库/">数据库</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/服务器/">服务器</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Apisix/" style="font-size: 10px;">Apisix</a> <a href="/tags/Etcd/" style="font-size: 20px;">Etcd</a> <a href="/tags/apisix/" style="font-size: 10px;">apisix</a> <a href="/tags/%E7%BD%91%E5%85%B3/" style="font-size: 10px;">网关</a>
    </div>
    
  </div>

    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>



    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">最新文章</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/2021/09-15-apisix%E5%9F%BA%E4%BA%8E%E7%AB%AF%E5%8F%A3%E7%9A%84SSL%E8%B7%AF%E7%94%B1/">apisix基于端口的SSL路由</a>
          </li>
        
          <li>
            <a href="/2021/09-11-apisix%E5%9F%BA%E4%BA%8Eusername%E5%92%8Cpassword%E7%9A%84JWT%E9%AA%8C%E8%AF%81%E6%8F%92%E4%BB%B6/">apisix基于username和password的JWT验证插件</a>
          </li>
        
          <li>
            <a href="/2021/09-06-Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84etcd%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA/">Docker环境下的etcd集群的搭建</a>
          </li>
        
          <li>
            <a href="/2021/09-05-CentOS%E4%B8%8B%E7%9A%84etcd%E7%9A%84%E6%90%AD%E5%BB%BA/">CentOS下的etcd的搭建</a>
          </li>
        
      </ul>
    </div>
  </div>

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 cn_wumo
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br/><a target="_blank" href="https://beian.miit.gov.cn/" rel="external nofollow noopener noreferrer">闽ICP备2021013451号</a>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: NaN%;"> 
              <img data-src="https://cdn.jsdelivr.net/gh/cn-wumo/cn-wumo.github.io@latest/images/apisix基于username和password的JWT验证插件.jpeg" data-sizes="auto" alt="apisix基于username和password的JWT验证插件" class="lazyload">
              <h1>apisix基于username和password的JWT验证插件</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2021年09月11日</a>
    <a><i class="nexmoefont icon-areachart"></i>2k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 12 分钟</a>
</div>

      

      <h1 id="插件说明"><a href="#插件说明" class="headerlink" title="插件说明"></a>插件说明</h1><p>基于jwt-auth插件，新增了password字段和相应的逻辑判断。</p>
<p>jwt-diy的属性表如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>必选项</th>
<th>默认值</th>
<th>有效值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>key</td>
<td>string</td>
<td>必须</td>
<td></td>
<td></td>
<td>不同的 consumer 对象应有不同的值，它应当是唯一的。不同 consumer 使用了相同的 key ，将会出现请求匹配异常。</td>
</tr>
<tr>
<td>password</td>
<td>string</td>
<td>必须</td>
<td></td>
<td></td>
<td>Key对应的口令，唯有key和password相匹配才会返回token</td>
</tr>
<tr>
<td>secret</td>
<td>string</td>
<td>可选</td>
<td></td>
<td></td>
<td>加密秘钥。如果您未指定，后台将会自动帮您生成。</td>
</tr>
<tr>
<td>public_key</td>
<td>string</td>
<td>可选</td>
<td></td>
<td></td>
<td>RSA 公钥， algorithm 属性选择 RS256 算法时必填</td>
</tr>
<tr>
<td>private_key</td>
<td>string</td>
<td>可选</td>
<td></td>
<td></td>
<td>RSA 私钥， algorithm 属性选择 RS256 算法时必填</td>
</tr>
<tr>
<td>algorithm</td>
<td>string</td>
<td>可选</td>
<td>“HS256”</td>
<td>[“HS256”, “HS512”, “RS256”]</td>
<td>加密算法</td>
</tr>
<tr>
<td>exp</td>
<td>integer</td>
<td>可选</td>
<td>86400</td>
<td>[1,…]</td>
<td>token 的超时时间</td>
</tr>
<tr>
<td>base64_secret</td>
<td>boolean</td>
<td>可选</td>
<td>false</td>
<td></td>
<td>密钥是否为 base64 编码</td>
</tr>
</tbody></table>
<h1 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h1><h2 id="复制插件到plugins目录"><a href="#复制插件到plugins目录" class="headerlink" title="复制插件到plugins目录"></a>复制插件到plugins目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/apisix/apisix/plugins</span><br><span class="line">vi ./jwt-diy.lua    #键入插件代码</span><br></pre></td></tr></table></figure>

<h2 id="修改默认配置"><a href="#修改默认配置" class="headerlink" title="修改默认配置"></a>修改默认配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/apisix/conf</span><br><span class="line">vi ./config-default.yaml    #修改默认配置</span><br></pre></td></tr></table></figure>
<h2 id="键入配置信息"><a href="#键入配置信息" class="headerlink" title="键入配置信息"></a>键入配置信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">……</span><br><span class="line">plugins:                          # plugin list (sorted by priority)</span><br><span class="line">  - client-control                 # priority: 22000</span><br><span class="line">  - ext-plugin-pre-req             # priority: 12000</span><br><span class="line">  - zipkin                         # priority: 11011</span><br><span class="line">  - request-id                     # priority: 11010</span><br><span class="line">  - fault-injection                # priority: 11000</span><br><span class="line">  - serverless-pre-function        # priority: 10000</span><br><span class="line">  - batch-requests                 # priority: 4010</span><br><span class="line">  - cors                           # priority: 4000</span><br><span class="line">  - ip-restriction                 # priority: 3000</span><br><span class="line">  - referer-restriction            # priority: 2990</span><br><span class="line">  - uri-blocker                    # priority: 2900</span><br><span class="line">  - request-validation             # priority: 2800</span><br><span class="line">  - openid-connect                 # priority: 2599</span><br><span class="line">  - wolf-rbac                      # priority: 2555</span><br><span class="line">  - hmac-auth                      # priority: 2530</span><br><span class="line">  - basic-auth                     # priority: 2520</span><br><span class="line">  - jwt-auth                       # priority: 2510</span><br><span class="line">  - key-auth                       # priority: 2500</span><br><span class="line">  - consumer-restriction           # priority: 2400</span><br><span class="line">  - authz-keycloak                 # priority: 2000</span><br><span class="line">  #- error-log-logger              # priority: 1091</span><br><span class="line">  - proxy-mirror                   # priority: 1010</span><br><span class="line">  - proxy-cache                    # priority: 1009</span><br><span class="line">  - proxy-rewrite                  # priority: 1008</span><br><span class="line">  - api-breaker                    # priority: 1005</span><br><span class="line">  - limit-conn                     # priority: 1003</span><br><span class="line">  - limit-count                    # priority: 1002</span><br><span class="line">  - limit-req                      # priority: 1001</span><br><span class="line">  #- node-status                   # priority: 1000</span><br><span class="line">  - server-info                    # priority: 990</span><br><span class="line">  - traffic-split                  # priority: 966</span><br><span class="line">  - redirect                       # priority: 900</span><br><span class="line">  - response-rewrite               # priority: 899</span><br><span class="line">  #- dubbo-proxy                   # priority: 507</span><br><span class="line">  - grpc-transcode                 # priority: 506</span><br><span class="line">  - prometheus                     # priority: 500</span><br><span class="line">  - echo                           # priority: 412</span><br><span class="line">  - http-logger                    # priority: 410</span><br><span class="line">  - sls-logger                     # priority: 406</span><br><span class="line">  - tcp-logger                     # priority: 405</span><br><span class="line">  - kafka-logger                   # priority: 403</span><br><span class="line">  - syslog                         # priority: 401</span><br><span class="line">  - udp-logger                     # priority: 400</span><br><span class="line">  #- log-rotate                    # priority: 100</span><br><span class="line">  # &lt;- recommend to use priority (0, 100) for your custom plugins</span><br><span class="line">  #键入jwt-diy插件的文件名</span><br><span class="line">- jwt-diy                        # priority: 1 </span><br><span class="line">  - example-plugin                 # priority: 0</span><br><span class="line">  #- skywalking                    # priority: -1100</span><br><span class="line">  - serverless-post-function       # priority: -2000</span><br><span class="line">  - ext-plugin-post-req            # priority: -3000</span><br><span class="line"></span><br><span class="line">stream_plugins: # sorted by priority</span><br><span class="line">  - mqtt-proxy                     # priority: 1000</span><br><span class="line">  # &lt;- recommend to use priority (0, 100) for your custom plugins</span><br><span class="line">……</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<h1 id="如何启用"><a href="#如何启用" class="headerlink" title="如何启用"></a>如何启用</h1><h2 id="创建一个-consumer-对象，指定RSA算法，并设置插件-jwt-diy的值，配置公钥和私钥。"><a href="#创建一个-consumer-对象，指定RSA算法，并设置插件-jwt-diy的值，配置公钥和私钥。" class="headerlink" title="创建一个 consumer 对象，指定RSA算法，并设置插件 jwt-diy的值，配置公钥和私钥。"></a>创建一个 consumer 对象，指定RSA算法，并设置插件 jwt-diy的值，配置公钥和私钥。</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">curl http://0.0.0.0:9080/apisix/admin/consumers -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;username&quot;: &quot;user&quot;,</span><br><span class="line">    &quot;plugins&quot;: &#123;</span><br><span class="line">        &quot;jwt-diy&quot;: &#123;</span><br><span class="line">            &quot;key&quot;: user-key,</span><br><span class="line">            &quot;password&quot;: password,</span><br><span class="line">            &quot;public_key&quot;: &quot;-----BEGIN PUBLIC KEY-----</span><br><span class="line">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAM++1NAk1SnpjHgglXDWypaFdff07ymE</span><br><span class="line">mI9AKYHgRNwutnIDN8CD2Pm4uHPtGCkkV1GAJZJkmOCsRULwGh51NdECAwEAAQ==</span><br><span class="line">-----END PUBLIC KEY-----&quot;,</span><br><span class="line">            &quot;private_key&quot;: &quot;-----BEGIN PRIVATE KEY-----</span><br><span class="line">MIIBVQIBADANBgkqhkiG9w0BAQEFAASCAT8wggE7AgEAAkEAz77U0CTVKemMeCCV</span><br><span class="line">cNbKloV19/TvKYSYj0ApgeBE3C62cgM3wIPY+bi4c+0YKSRXUYAlkmSY4KxFQvAa</span><br><span class="line">HnU10QIDAQABAkB5CG8oTS072+uQ2Tr3oMwq4dqW+caU48GWRAVqu2Si+i7k3Igi</span><br><span class="line">tqaz/xAs2iXTdj/W1F8tNmw2xsKBILN6LpGhAiEA9aHWC7FkRjPYrBDv5zvvR8pc</span><br><span class="line">+CspzOHKrgyiBmKWwQ0CIQDYg5y+24S5jHv48Yr2/KeKug09S9Y60RhED5IEzZ9u</span><br><span class="line">1QIhAMHKOa4l+R+t3d76ydscHQ79p9WfcC4VYatpihcRhzCtAiEA142AGcs2QfwI</span><br><span class="line">2Hiw3t/+dPBxidrcd0YAIJJXzwxfc9kCIHVytvdYljt1letwDHCnloa0dQmhZUvJ</span><br><span class="line">+IEib4YXcSPh</span><br><span class="line">-----END PRIVATE KEY-----&quot;,</span><br><span class="line">            &quot;algorithm&quot;: &quot;RS256&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="创建Route或Service对象，开启jwt-diy插件"><a href="#创建Route或Service对象，开启jwt-diy插件" class="headerlink" title="创建Route或Service对象，开启jwt-diy插件"></a>创建Route或Service对象，开启jwt-diy插件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H &#x27;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#x27; -X PUT -d &#x27;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;methods&quot;: [&quot;GET&quot;],</span><br><span class="line">    &quot;uri&quot;: &quot;/index.html&quot;,</span><br><span class="line">    &quot;plugins&quot;: &#123;</span><br><span class="line">        &quot;jwt-diy&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;upstream&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;roundrobin&quot;,</span><br><span class="line">        &quot;nodes&quot;: &#123;</span><br><span class="line">            &quot;httpunit.sourceforge.net&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;scheme&quot;: &quot;http&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl http://0.0.0.0:9080/apisix/plugin/jwt/sign?key=user-key\&amp;password=password –i</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 11 Aug 2021 02:42:19 GMT</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Server: APISIX/2.7</span><br><span class="line"></span><br><span class="line">eyJhbGciOiJSUzI1NiIsIng1YyI6WyItLS0tLUJFR0lOIFBVQkxJQyBLRVktLS0tLVxuTUZ3d0RRWUpLb1pJaHZjTkFRRUJCUUFEU3dBd1NBSkJBTSsrMU5BazFTbnBqSGdnbFhEV3lwYUZkZmYwN3ltRVxubUk5QUtZSGdSTnd1dG5JRE44Q0QyUG00dUhQdEdDa2tWMUdBSlpKa21PQ3NSVUx3R2g1MU5kRUNBd0VBQVE9PVxuLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tIl0sInR5cCI6IkpXVCJ9.eyJrZXkiOiJ1c2VyLWtleSIsImV4cCI6MTYyODczNjEzOX0.JcWTONIumTfwZjfsx0kxNGIA_DpPCXmhIf9EWQxGG7y_UL6s_4eFvV-iAeqIt8yshR12DcaR6R9jMpCoCiYB3A</span><br></pre></td></tr></table></figure>
<h1 id="插件代码"><a href="#插件代码" class="headerlink" title="插件代码"></a>插件代码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line">-- Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="line">-- contributor license agreements.  See the NOTICE file distributed with</span><br><span class="line">-- this work for additional information regarding copyright ownership.</span><br><span class="line">-- The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="line">-- (the &quot;License&quot;); you may not use this file except in compliance with</span><br><span class="line">-- the License.  You may obtain a copy of the License at</span><br><span class="line">--</span><br><span class="line">--     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">--</span><br><span class="line">-- Unless required by applicable law or agreed to in writing, software</span><br><span class="line">-- distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">-- See the License for the specific language governing permissions and</span><br><span class="line">-- limitations under the License.</span><br><span class="line">--</span><br><span class="line">local core     = require(&quot;apisix.core&quot;)</span><br><span class="line">local jwt      = require(&quot;resty.jwt&quot;)</span><br><span class="line">local ck       = require(&quot;resty.cookie&quot;)</span><br><span class="line">local consumer_mod = require(&quot;apisix.consumer&quot;)</span><br><span class="line">local resty_random = require(&quot;resty.random&quot;)</span><br><span class="line"></span><br><span class="line">local ngx_encode_base64 = ngx.encode_base64</span><br><span class="line">local ngx_decode_base64 = ngx.decode_base64</span><br><span class="line">local ipairs   = ipairs</span><br><span class="line">local ngx      = ngx</span><br><span class="line">local ngx_time = ngx.time</span><br><span class="line">local sub_str  = string.sub</span><br><span class="line">local plugin_name = &quot;jwt-diy&quot;</span><br><span class="line">local pcall = pcall</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local lrucache = core.lrucache.new(&#123;</span><br><span class="line">    type = &quot;plugin&quot;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">local schema = &#123;</span><br><span class="line">    type = &quot;object&quot;,</span><br><span class="line">    additionalProperties = false,</span><br><span class="line">    properties = &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">local consumer_schema = &#123;</span><br><span class="line">    type = &quot;object&quot;,</span><br><span class="line">    -- can&#x27;t use additionalProperties with dependencies</span><br><span class="line">    -- additionalProperties = false,</span><br><span class="line">    properties = &#123;</span><br><span class="line">        key = &#123;type = &quot;string&quot;&#125;,</span><br><span class="line">        secret = &#123;type = &quot;string&quot;&#125;,</span><br><span class="line">        password = &#123;type = &quot;string&quot;&#125;,   --changed</span><br><span class="line">        algorithm = &#123;</span><br><span class="line">            type = &quot;string&quot;,</span><br><span class="line">            enum = &#123;&quot;HS256&quot;, &quot;HS512&quot;, &quot;RS256&quot;&#125;,</span><br><span class="line">            default = &quot;HS256&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        exp = &#123;type = &quot;integer&quot;, minimum = 1, default = 86400&#125;,</span><br><span class="line">        base64_secret = &#123;</span><br><span class="line">            type = &quot;boolean&quot;,</span><br><span class="line">            default = false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    dependencies = &#123;</span><br><span class="line">        algorithm = &#123;</span><br><span class="line">            oneOf = &#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    properties = &#123;</span><br><span class="line">                        algorithm = &#123;</span><br><span class="line">                            enum = &#123;&quot;HS256&quot;, &quot;HS512&quot;&#125;,</span><br><span class="line">                            default = &quot;HS256&quot;</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    properties = &#123;</span><br><span class="line">                        public_key = &#123;type = &quot;string&quot;&#125;,</span><br><span class="line">                        private_key= &#123;type = &quot;string&quot;&#125;,</span><br><span class="line">                        algorithm = &#123;</span><br><span class="line">                            enum = &#123;&quot;RS256&quot;&#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                    required = &#123;&quot;public_key&quot;, &quot;private_key&quot;&#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    required = &#123;&quot;key&quot;,&quot;password&quot;&#125;,  --changed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local _M = &#123;</span><br><span class="line">    version = 0.1,</span><br><span class="line">    priority = 1,</span><br><span class="line">    type = &#x27;auth&#x27;,</span><br><span class="line">    name = plugin_name,</span><br><span class="line">    schema = schema,</span><br><span class="line">    consumer_schema = consumer_schema</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local create_consume_cache</span><br><span class="line">do</span><br><span class="line">    local consumer_names = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function create_consume_cache(consumers)</span><br><span class="line">        core.table.clear(consumer_names)</span><br><span class="line"></span><br><span class="line">        for _, consumer in ipairs(consumers.nodes) do</span><br><span class="line">            core.log.info(&quot;consumer node: &quot;, core.json.delay_encode(consumer))</span><br><span class="line">            consumer_names[consumer.auth_conf.key] = consumer</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        return consumer_names</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">end -- do</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function _M.check_schema(conf, schema_type)</span><br><span class="line">    core.log.info(&quot;input conf: &quot;, core.json.delay_encode(conf))</span><br><span class="line"></span><br><span class="line">    local ok, err</span><br><span class="line">    if schema_type == core.schema.TYPE_CONSUMER then</span><br><span class="line">        ok, err = core.schema.check(consumer_schema, conf)</span><br><span class="line">    else</span><br><span class="line">        ok, err = core.schema.check(schema, conf)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    if not ok then</span><br><span class="line">        return false, err</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    if schema_type == core.schema.TYPE_CONSUMER then</span><br><span class="line">        if conf.algorithm ~= &quot;RS256&quot; and not conf.secret then</span><br><span class="line">            conf.secret = ngx_encode_base64(resty_random.bytes(32, true))</span><br><span class="line">        elseif conf.base64_secret then</span><br><span class="line">            if ngx_decode_base64(conf.secret) == nil then</span><br><span class="line">                return false, &quot;base64_secret required but the secret is not in base64 format&quot;</span><br><span class="line">            end</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        if conf.algorithm == &quot;RS256&quot; then</span><br><span class="line">            if not conf.public_key then</span><br><span class="line">                return false, &quot;missing valid public key&quot;</span><br><span class="line">            end</span><br><span class="line">            if not conf.private_key then</span><br><span class="line">                return false, &quot;missing valid private key&quot;</span><br><span class="line">            end</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    return true</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local function fetch_jwt_token(ctx)</span><br><span class="line">    local token = core.request.header(ctx, &quot;authorization&quot;)</span><br><span class="line">    if token then</span><br><span class="line">        local prefix = sub_str(token, 1, 7)</span><br><span class="line">        if prefix == &#x27;Bearer &#x27; or prefix == &#x27;bearer &#x27; then</span><br><span class="line">            return sub_str(token, 8)</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        return token</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    token = ctx.var.arg_jwt</span><br><span class="line">    if token then</span><br><span class="line">        return token</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local cookie, err = ck:new()</span><br><span class="line">    if not cookie then</span><br><span class="line">        return nil, err</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local val, err = cookie:get(&quot;jwt&quot;)</span><br><span class="line">    return val, err</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local function get_secret(conf)</span><br><span class="line">    if conf.base64_secret then</span><br><span class="line">        return ngx_decode_base64(conf.secret)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    return conf.secret</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local function get_real_payload(key, auth_conf, payload)</span><br><span class="line">    local real_payload = &#123;</span><br><span class="line">        key = key,</span><br><span class="line">        exp = ngx_time() + auth_conf.exp</span><br><span class="line">    &#125;</span><br><span class="line">    if payload then</span><br><span class="line">        local extra_payload = core.json.decode(payload)</span><br><span class="line">        core.table.merge(real_payload, extra_payload)</span><br><span class="line">    end</span><br><span class="line">    return real_payload</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local function sign_jwt_with_HS(key, auth_conf, payload)</span><br><span class="line">    local auth_secret = get_secret(auth_conf)</span><br><span class="line">    local ok, jwt_token = pcall(jwt.sign, _M,</span><br><span class="line">        auth_secret,</span><br><span class="line">        &#123;</span><br><span class="line">            header = &#123;</span><br><span class="line">                typ = &quot;JWT&quot;,</span><br><span class="line">                alg = auth_conf.algorithm</span><br><span class="line">            &#125;,</span><br><span class="line">            payload = get_real_payload(key, auth_conf, payload)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    if not ok then</span><br><span class="line">        core.log.warn(&quot;failed to sign jwt, err: &quot;, jwt_token.reason)</span><br><span class="line">        core.response.exit(500, &quot;failed to sign jwt&quot;)</span><br><span class="line">    end</span><br><span class="line">    return jwt_token</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local function sign_jwt_with_RS256(key, auth_conf, payload)</span><br><span class="line">    local ok, jwt_token = pcall(jwt.sign, _M,</span><br><span class="line">        auth_conf.private_key,</span><br><span class="line">        &#123;</span><br><span class="line">            header = &#123;</span><br><span class="line">                typ = &quot;JWT&quot;,</span><br><span class="line">                alg = auth_conf.algorithm,</span><br><span class="line">                x5c = &#123;</span><br><span class="line">                    auth_conf.public_key,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            payload = get_real_payload(key, auth_conf, payload)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    if not ok then</span><br><span class="line">        core.log.warn(&quot;failed to sign jwt, err: &quot;, jwt_token.reason)</span><br><span class="line">        core.response.exit(500, &quot;failed to sign jwt&quot;)</span><br><span class="line">    end</span><br><span class="line">    return jwt_token</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local function algorithm_handler(consumer)</span><br><span class="line">    if not consumer.auth_conf.algorithm or consumer.auth_conf.algorithm == &quot;HS256&quot;</span><br><span class="line">            or consumer.auth_conf.algorithm == &quot;HS512&quot; then</span><br><span class="line">        return sign_jwt_with_HS, get_secret(consumer.auth_conf)</span><br><span class="line">    elseif consumer.auth_conf.algorithm == &quot;RS256&quot; then</span><br><span class="line">        return sign_jwt_with_RS256, consumer.auth_conf.public_key</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function _M.rewrite(conf, ctx)</span><br><span class="line">    local jwt_token, err = fetch_jwt_token(ctx)</span><br><span class="line">    if not jwt_token then</span><br><span class="line">        if err and err:sub(1, #&quot;no cookie&quot;) ~= &quot;no cookie&quot; then</span><br><span class="line">            core.log.error(&quot;failed to fetch JWT token: &quot;, err)</span><br><span class="line">        end</span><br><span class="line"></span><br><span class="line">        return 401, &#123;message = &quot;Missing JWT token in request&quot;&#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local jwt_obj = jwt:load_jwt(jwt_token)</span><br><span class="line">    core.log.info(&quot;jwt object: &quot;, core.json.delay_encode(jwt_obj))</span><br><span class="line">    if not jwt_obj.valid then</span><br><span class="line">        return 401, &#123;message = jwt_obj.reason&#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local user_key = jwt_obj.payload and jwt_obj.payload.key</span><br><span class="line">    if not user_key then</span><br><span class="line">        return 401, &#123;message = &quot;missing user key in JWT token&quot;&#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local consumer_conf = consumer_mod.plugin(plugin_name)</span><br><span class="line">    if not consumer_conf then</span><br><span class="line">        return 401, &#123;message = &quot;Missing related consumer&quot;&#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local consumers = lrucache(&quot;consumers_key&quot;, consumer_conf.conf_version,</span><br><span class="line">        create_consume_cache, consumer_conf)</span><br><span class="line"></span><br><span class="line">    local consumer = consumers[user_key]</span><br><span class="line">    if not consumer then</span><br><span class="line">        return 401, &#123;message = &quot;Invalid user key in JWT token&quot;&#125;</span><br><span class="line">    end</span><br><span class="line">    core.log.info(&quot;consumer: &quot;, core.json.delay_encode(consumer))</span><br><span class="line"></span><br><span class="line">    local _, auth_secret = algorithm_handler(consumer)</span><br><span class="line">    jwt_obj = jwt:verify_jwt_obj(auth_secret, jwt_obj)</span><br><span class="line">    core.log.info(&quot;jwt object: &quot;, core.json.delay_encode(jwt_obj))</span><br><span class="line"></span><br><span class="line">    if not jwt_obj.verified then</span><br><span class="line">        return 401, &#123;message = jwt_obj.reason&#125;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    consumer_mod.attach_consumer(ctx, consumer, consumer_conf)</span><br><span class="line">    core.log.info(&quot;hit jwt-auth rewrite&quot;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local function gen_token()</span><br><span class="line">    local args = ngx.req.get_uri_args()</span><br><span class="line">    if not args or not args.key or not args.password then   --changed</span><br><span class="line">        return core.response.exit(400)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local key = args.key</span><br><span class="line">    local payload = args.payload</span><br><span class="line">    local password = args.password   --changed</span><br><span class="line">    if payload then</span><br><span class="line">        payload = ngx.unescape_uri(payload)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local consumer_conf = consumer_mod.plugin(plugin_name)</span><br><span class="line">    if not consumer_conf then</span><br><span class="line">        return core.response.exit(404)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local consumers = lrucache(&quot;consumers_key&quot;, consumer_conf.conf_version,</span><br><span class="line">        create_consume_cache, consumer_conf)</span><br><span class="line"></span><br><span class="line">    core.log.info(&quot;consumers: &quot;, core.json.delay_encode(consumers))</span><br><span class="line">    local consumer = consumers[key]</span><br><span class="line">    </span><br><span class="line">    if ((not consumer) or (password ~= consumer.auth_conf.password)) then   --changed</span><br><span class="line">        return core.response.exit(404)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    core.log.info(&quot;consumer: &quot;, core.json.delay_encode(consumer))</span><br><span class="line"></span><br><span class="line">    local sign_handler, _ = algorithm_handler(consumer)</span><br><span class="line">    local jwt_token = sign_handler(key, consumer.auth_conf, payload)</span><br><span class="line">    if jwt_token then</span><br><span class="line">        return core.response.exit(200, jwt_token)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    return core.response.exit(404)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function _M.api()</span><br><span class="line">    return &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            methods = &#123;&quot;GET&quot;&#125;,</span><br><span class="line">            uri = &quot;/apisix/plugin/jwt/sign&quot;,</span><br><span class="line">            handler = gen_token,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">return _M</span><br></pre></td></tr></table></figure>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>cn_wumo<br>
        <strong>本文链接：</strong><a href="http://cn-wumo.top/2021/09-11-apisix%E5%9F%BA%E4%BA%8Eusername%E5%92%8Cpassword%E7%9A%84JWT%E9%AA%8C%E8%AF%81%E6%8F%92%E4%BB%B6/" title="http:&#x2F;&#x2F;cn-wumo.top&#x2F;2021&#x2F;09-11-apisix%E5%9F%BA%E4%BA%8Eusername%E5%92%8Cpassword%E7%9A%84JWT%E9%AA%8C%E8%AF%81%E6%8F%92%E4%BB%B6&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;cn-wumo.top&#x2F;2021&#x2F;09-11-apisix%E5%9F%BA%E4%BA%8Eusername%E5%92%8Cpassword%E7%9A%84JWT%E9%AA%8C%E8%AF%81%E6%8F%92%E4%BB%B6&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Apisix/" rel="tag">Apisix</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E7%BD%91%E5%85%B3/" rel="tag">网关</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '4db3627893f90bce02d9',
        clientSecret: 'bcdf49fb88cf903dd8c2b06d8e45b2437a77e3f8',
	id: 'apisix基于username和password的JWT验证插件',
        repo: 'cn-wumo.github.io',
        owner: 'cn-wumo',
        admin: 'cn-wumo'
    })
    gitalk.render('gitalk')
</script>

</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1631693947705"></script>

<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
